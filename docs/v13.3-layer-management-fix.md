# Goxel v13.3 Layer Management Fix Documentation

**Date**: January 26, 2025  
**Version**: v13.3.0  
**Author**: Development Team  
**Status**: ✅ Completed

## Executive Summary

This document details the critical layer management fixes implemented in Goxel v13.3. The primary issue was that each file load operation created duplicate layers, causing confusion and incorrect behavior in CLI operations. This has been completely resolved through systematic code improvements.

## Problem Description

### Primary Issue: Layer Duplication
- **Symptom**: Every time a GOX file was loaded, an extra layer was created
- **Impact**: 
  - After multiple voxel-add operations, projects had multiple unnecessary layers
  - Voxels were scattered across different layers instead of being in one layer
  - GUI display showed incorrect layer structure
  - Memory waste and confusion for users

### Root Cause Analysis
1. **`image_new()` function** automatically created a default layer
2. **GOX file loader** would then add layers from the file
3. **Result**: Always had at least one extra layer than intended

### Example Scenario
```bash
# Create new project (1 layer created)
./goxel-headless create test.gox

# Add first voxel (file loaded, now 2 layers)
./goxel-headless voxel-add test.gox --pos 32,32,32 --color 255,0,0,255

# Add second voxel (file loaded again, now 3 layers)
./goxel-headless voxel-add test.gox --pos 30,30,30 --color 0,255,0,255
```

## Solution Implementation

### 1. Created `image_new_empty()` Function

**File**: `src/core/image.c`

```c
// Create an empty image without default layer - used for file loading
image_t *image_new_empty(void)
{
    image_t *img = calloc(1, sizeof(*img));
    img->ref = 1;
    const int aabb[2][3] = {{-16, -16, 0}, {16, 16, 32}};
    bbox_from_aabb(img->box, aabb);
    img->export_width = 1024;
    img->export_height = 1024;
    // Only add material and camera, but no default layer
    image_add_material(img, NULL);
    image_add_camera(img, NULL);
    // Prevent saving an empty image.
    img->saved_key = image_get_key(img);
    image_history_push(img);
    return img;
}
```

### 2. Updated Header Declaration

**File**: `src/core/image.h`

```c
image_t *image_new(void);
image_t *image_new_empty(void);  // Added this declaration
```

### 3. Modified File Loading Logic

**File**: `src/core/goxel_core_load.c`

```c
// Phase 2: Isolated GOX loading (avoid global sync during load)
// Use image_new_empty() to avoid creating default layer
image_t *temp_image = image_new_empty();
if (!temp_image) {
    LOG_E("Failed to create temporary image for loading");
    return -1;
}
```

### 4. Enhanced Layer Safety

**File**: `src/core/image.c`

Multiple functions were updated to check for null active_layer:

```c
// In image_restore()
// Only assert if there are layers
if (img->layers) assert(img->active_layer);

// In image_clear_layer()
layer_t *layer = img->active_layer;
if (!layer) return; // No active layer to clear

// In all ACTION functions
static void a_image_delete_layer(void)
{
    if (goxel.image->active_layer)
        image_delete_layer(goxel.image, goxel.image->active_layer);
}
```

## Files Modified

### Core Changes
1. **`src/core/image.c`**
   - Added `image_new_empty()` function
   - Updated `image_restore()` to handle empty layer lists
   - Updated `image_snapshot()` to handle empty layer lists
   - Added null checks in all ACTION_REGISTER functions

2. **`src/core/image.h`**
   - Added declaration for `image_new_empty()`

3. **`src/core/goxel_core_load.c`**
   - Changed from `image_new()` to `image_new_empty()` in loading logic

### Supporting Changes
4. **`src/core/goxel_core.c`**
   - Already had proper layer finding logic with fallback

5. **`src/core/formats/gox.c`**
   - No changes needed - loader was already correct

## Testing and Validation

### Test Script Created
**File**: `test_gui_display.sh`

```bash
#!/bin/bash

# Test script for GUI display of CLI-created voxels

echo "Creating test project with voxels in different positions..."

# Clean up previous test files
rm -f test_gui_*.gox

# Create a new project
./goxel-headless create test_gui_display.gox

# Add voxels at different heights to test positioning
echo "Adding voxels at different Z coordinates..."

# Red voxel at ground level (z=16)
./goxel-headless voxel-add test_gui_display.gox --pos 32,32,16 --color 255,0,0,255

# Green voxel at mid level (z=32)
./goxel-headless voxel-add test_gui_display.gox --pos 30,32,32 --color 0,255,0,255

# Blue voxel at upper level (z=48)
./goxel-headless voxel-add test_gui_display.gox --pos 34,32,48 --color 0,0,255,255

# Yellow voxel at very low level (z=0)
./goxel-headless voxel-add test_gui_display.gox --pos 32,30,0 --color 255,255,0,255

# Purple voxel at high level (z=60)
./goxel-headless voxel-add test_gui_display.gox --pos 32,34,60 --color 255,0,255,255
```

### Test Results
- ✅ Only 1 layer created (previously would have 6 layers)
- ✅ All voxels in the same layer
- ✅ Correct colors preserved
- ✅ Correct positions preserved
- ✅ No crashes or errors

## Performance Impact

- **Memory Usage**: Reduced by eliminating unnecessary layers
- **File Size**: Smaller due to fewer layer metadata entries
- **Load Time**: Slightly faster due to less layer processing
- **No negative performance impacts**

## Migration Guide

### For Developers
- If using `image_new()` for file loading, switch to `image_new_empty()`
- Always check `active_layer` for null before operations
- Layer IDs are now preserved correctly during load/save

### For Users
- No action required
- Existing GOX files will load correctly
- New files created will have proper layer structure

## Future Considerations

1. **Batch Operations**: The fix enables efficient batch voxel operations
2. **Layer Merging**: Could implement automatic layer merging for optimization
3. **Layer Templates**: Could add support for pre-defined layer structures

## Conclusion

The layer management fix in v13.3 eliminates a critical issue that caused confusion and inefficiency in CLI operations. The solution is elegant, minimal, and maintains backward compatibility while significantly improving the user experience.

### Key Achievements
- ✅ Zero duplicate layers
- ✅ Consistent layer management
- ✅ Improved memory efficiency
- ✅ Better CLI workflow
- ✅ Full backward compatibility

---

**Documentation Version**: 1.0  
**Last Updated**: January 26, 2025