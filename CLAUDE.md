# CLAUDE.md - Goxel 3D Voxel Editor

## Project Overview

Goxel is a cross-platform 3D voxel editor written primarily in C99 with some C++ components. It allows users to create voxel graphics (3D images formed of cubes) and supports multiple export formats. The project is maintained by Guillaume Chereau and released under GNU GPL3 license.

**Key Features:**
- 24-bit RGB colors
- Unlimited scene size and undo buffer
- Layer support
- Marching cube rendering
- Procedural rendering
- Ray tracing
- Multiple export formats (OBJ, PLY, PNG, Magica Voxel, Qubicle, etc.)

**Official Website:** https://goxel.xyz  
**Platforms:** Linux, BSD, Windows, macOS, iOS, Android

## Architecture Overview

### Core Data Structures

The architecture follows a hierarchical voxel storage system:

1. **Blocks** (`block_t`): Store 16³ voxels with copy-on-write mechanism and reference counting
2. **Block Data** (`block_data_t`): Actual voxel data, copied only when modified
3. **Volumes** (`volume_t`): Collections of blocks, also using copy-on-write
4. **Layers** (`layer_t`): Volumes with additional attributes
5. **Images** (`image_t`): Collections of layers with undo history snapshots

### Key Systems

- **Rendering System**: Deferred rendering using `render_xxx` functions that build operation lists executed by `render_render`
- **Tool System**: Modular tools for different voxel operations (brush, selection, extrude, etc.)
- **Asset System**: Assets embedded in C code via `src/assets.inl`, generated by Python scripts
- **GUI System**: Uses Dear ImGui with custom widgets in `src/imgui_user.inl`
- **File Format System**: Pluggable import/export system supporting multiple voxel formats

## Technology Stack

### Core Languages & Standards
- **C99**: Main codebase with GNU extensions
- **C++17**: Some components (ImGui integration, mesh optimization, path tracing)
- **GLSL**: Shaders for rendering
- **JavaScript**: Scripting support via QuickJS

### Graphics & UI
- **OpenGL**: 3D rendering
- **GLFW3**: Window management and input
- **Dear ImGui**: Immediate mode GUI
- **GLEW**: OpenGL extension loading (Windows)

### Build System & Tools
- **SCons**: Primary build system
- **Make**: Wrapper around SCons with common targets
- **Python**: Asset generation and tooling

### External Dependencies
Key external libraries in `ext_src/`:
- **stb**: Image loading/writing, truetype, data structures
- **imgui**: GUI framework with ImGuizmo for 3D gizmos
- **quickjs**: JavaScript engine for scripting
- **meshoptimizer**: Mesh optimization
- **yocto**: Graphics utilities (BVH, ray tracing, etc.)
- **uthash**: Hash tables, arrays, lists
- **nfd**: Native file dialogs
- **xxhash**: Fast hashing
- **cgltf**: glTF support
- **voxelizer**: Mesh to voxel conversion

## Directory Structure

```
/
├── src/                    # Main source code
│   ├── tools/             # Voxel editing tools (brush, select, etc.)
│   ├── formats/           # Import/export format handlers
│   ├── gui/               # GUI panels and components  
│   ├── utils/             # Utility functions (math, file I/O, etc.)
│   ├── assets/            # Embedded assets (generated)
│   ├── goxel.h/.c         # Main application logic
│   ├── volume.h/.c        # Core voxel data structures
│   └── render.h/.c        # Rendering system
├── data/                  # Assets (fonts, icons, palettes, etc.)
├── ext_src/               # External dependencies
├── doc/                   # Documentation and contributor agreements
├── osx/                   # macOS-specific build files
├── snap/                  # Snap package configuration
├── tools/                 # Build and development tools
└── po/                    # Internationalization files
```

## Development Guidelines

### Code Style (from CONTRIBUTING.md)
- **Indentation**: 4 spaces, no tabs
- **Line width**: 80 characters maximum
- **Naming**: `snake_case` for functions and variables
- **Braces**: K&R style (opening brace on same line), except functions (next line)
- **Standards**: C99 with GNU extensions, C++17 for C++ files
- **Headers**: Include all needed headers, use include guards

### Key Coding Patterns
```c
// Function style
int my_function(void)
{
    int local_var;
    // Variable declarations at top
    // Implementation here
    return 0;
}

// Control structures
if (condition) {
    // code
} else {
    // code  
}
```

### Git Workflow
- **Commit messages**: <50 chars summary, 72-char wrapped body
- **CLA required**: Contributors must sign Contributor License Agreement
- **Branch**: `master` is main development branch
- **CI**: GitHub Actions builds for Linux, Windows, macOS
- **Git commits**: Do not include watermarks or co-authored-by lines when committing

### Development Methodology
- **Test-Driven Development (TDD)**: This project adopts TDD as the primary development approach
- **TDD Cycle**: Follow the Red-Green-Refactor cycle:
  1. **Red**: Write failing test first
  2. **Green**: Implement minimal code to make test pass
  3. **Refactor**: Improve code while keeping tests green
- **Clean Code**: Maintain high code quality following Clean Code principles
- **SOLID Principles**: Adhere to object-oriented SOLID principles:
  - **S**ingle Responsibility Principle
  - **O**pen/Closed Principle  
  - **L**iskov Substitution Principle
  - **I**nterface Segregation Principle
  - **D**ependency Inversion Principle
- **Task Order Execution**: When implementing features, ALWAYS follow the task sequence defined in the implementation plan
  - Refer to `/Users/jimmy/jimmy_side_projects/goxel/tasks/v13-implementation-plan.md` for proper task order
  - Complete Phase 1 tasks before moving to Phase 2
  - Mark tasks as completed in order using checkboxes
  - Do not skip ahead to later phases without completing prerequisites

## Build System

### Primary Commands
```bash
# Debug build
make
# or: scons

# Release build  
make release
# or: scons mode=release

# Profile build
scons mode=profile

# Clean
make clean
# or: scons -c

# Run
./goxel
```

### Platform-Specific Dependencies

**Linux/BSD:**
```bash
# Debian/Ubuntu
sudo apt-get install scons pkg-config libglfw3-dev libgtk-3-dev libpng-dev
```

**Windows (MSYS2):**
```bash
pacman -S mingw-w64-x86_64-gcc mingw-w64-x86_64-glfw mingw-w64-x86_64-libtre-git scons make
```

**macOS:**
```bash
brew install scons glfw tre
```

## Testing

- **Test file**: `/Users/jimmy/jimmy_side_projects/goxel/src/tests.c`
- **Test data**: Sample voxel files in `data/progs/`
- **CI**: Automated builds on Linux, Windows, macOS via GitHub Actions

## Key Files for Development

### Core Files
- `/Users/jimmy/jimmy_side_projects/goxel/src/goxel.h` - Main header with all includes
- `/Users/jimmy/jimmy_side_projects/goxel/src/goxel.c` - Application entry point and core logic
- `/Users/jimmy/jimmy_side_projects/goxel/src/volume.h/.c` - Core voxel data structures
- `/Users/jimmy/jimmy_side_projects/goxel/src/render.h/.c` - Rendering system

### Build Configuration
- `/Users/jimmy/jimmy_side_projects/goxel/SConstruct` - SCons build configuration
- `/Users/jimmy/jimmy_side_projects/goxel/Makefile` - Make wrapper
- `/Users/jimmy/jimmy_side_projects/goxel/src/config.h` - Compile-time configuration

### Documentation
- `/Users/jimmy/jimmy_side_projects/goxel/README.md` - User documentation
- `/Users/jimmy/jimmy_side_projects/goxel/INTERNALS.md` - Architecture overview
- `/Users/jimmy/jimmy_side_projects/goxel/CONTRIBUTING.md` - Development guidelines

## Development Workflow

1. **Setup**: Install platform-specific dependencies
2. **Build**: Use `make` or `scons` for debug builds
3. **Test**: Run `./goxel` to test functionality
4. **Development**: 
   - Add tools in `src/tools/`
   - Add file formats in `src/formats/`
   - Add GUI panels in `src/gui/`
5. **Assets**: Run `tools/create_assets.py` if modifying data files
6. **Release**: Use `make release` for optimized builds

## Scripting Support

Goxel includes JavaScript scripting via QuickJS:
- **Script files**: `data/scripts/`
- **API**: Exposed through `src/script.h/.c`
- **Example**: `data/scripts/test.js`

## Common Development Tasks

### Adding a New Tool
1. Create `src/tools/new_tool.c`
2. Register tool in `src/tools.c`
3. Add GUI panel in `src/gui/tools_panel.c`
4. Update `src/tools.h` with tool definition

### Adding Export Format
1. Create `src/formats/new_format.c`
2. Register format in `src/file_format.c`
3. Add export UI in `src/gui/export_panel.c`

### Modifying GUI
- GUI uses Dear ImGui immediate mode paradigm
- Panel implementations in `src/gui/`
- Custom widgets can be added to `src/imgui_user.inl`

## Performance Considerations

- **Copy-on-write**: Blocks and volumes use CoW for efficient memory usage
- **Deferred rendering**: Rendering commands are batched and executed together
- **Asset embedding**: Assets are compiled into binary for fast loading
- **Mesh optimization**: Uses meshoptimizer library for efficient geometry

This codebase is well-structured with clear separation of concerns, comprehensive documentation, and a mature build system supporting multiple platforms.

## External Documentation Index

### Goxel MCP v13 Documentation
When working on headless/MCP integration features, refer to these external documents:

- **Design Document**: `/Users/jimmy/jimmy_side_projects/goxel-mcp/docs/v13/goxel-headless-fork-design.md`
  - Complete architecture design for headless Goxel fork
  - CLI interface specifications
  - C API bridge design
  - MCP integration strategy
  - Performance targets and success criteria

- **Implementation Plan**: `/Users/jimmy/jimmy_side_projects/goxel/tasks/v13-implementation-plan.md`
  - Detailed task breakdown (139 trackable tasks)
  - 6-phase implementation roadmap
  - Milestone schedule and progress tracking
  - Success criteria validation checklist

### Related MCP Documentation
- **Goxel MCP Server**: Located in `/Users/jimmy/jimmy_side_projects/goxel-mcp/`
  - Current MCP server implementation
  - Tool definitions and capabilities
  - Integration patterns and examples

### Usage Notes
- Consult design document when making architectural decisions
- Use implementation plan to track progress and validate completeness
- Reference existing MCP server when designing headless integration
- Ensure compatibility with v13 specifications when implementing new features