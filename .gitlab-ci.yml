# GitLab CI Configuration for Goxel
# Focuses on running TDD tests for quality assurance

stages:
  - build
  - test

# Default settings for all jobs
default:
  # Use Ubuntu latest as base image
  image: ubuntu:22.04
  
  # Cache dependencies to speed up builds
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .apt-cache/
      - ext_src/

# Variables for all jobs
variables:
  # Debian frontend for non-interactive apt installs
  DEBIAN_FRONTEND: noninteractive
  # Use apt cache
  APT_CACHE_DIR: "$CI_PROJECT_DIR/.apt-cache"

# Setup common dependencies
.setup_dependencies: &setup_dependencies
  - apt-get update -qq
  - mkdir -p $APT_CACHE_DIR
  - apt-get install -o dir::cache::archives="$APT_CACHE_DIR" -y -qq
    build-essential
    gcc
    g++
    make
    scons
    pkg-config
    libglfw3-dev
    libgtk-3-dev
    libpng-dev
    libpng16-16
    git
    libtre-dev
    libglew-dev
    libosmesa6-dev
    libosmesa6

# Build job - compile only what's needed for TDD tests
build:tdd_tests:
  stage: build
  before_script:
    - *setup_dependencies
  script:
    - echo "üî® Building TDD test dependencies..."
    - echo "üîß Building goxel-daemon for integration tests..."
    - scons daemon=1  # Build daemon
    - echo "üß™ Building TDD test binaries..."
    - cd tests/tdd
    - make clean
    - make build
  artifacts:
    paths:
      - goxel-daemon
      - tests/tdd/example_voxel_tdd
      - tests/tdd/test_daemon_jsonrpc_tdd
      - tests/tdd/test_daemon_integration_tdd
    expire_in: 1 hour

# TDD Test job - run all TDD tests
test:tdd:
  stage: test
  needs: ["build:tdd_tests"]
  before_script:
    - apt-get update -qq
    # Install all runtime libraries needed by the daemon
    - apt-get install -y -qq bc libasan6 libubsan1 
      libgl1-mesa-glx libgtk-3-0 libglfw3 libglew2.2
      libglib2.0-0 libcairo2 libpango-1.0-0
      libosmesa6
      xvfb  # Virtual display for headless GUI
    # Start virtual display
    - export DISPLAY=:99
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - sleep 3  # Give xvfb time to start
  script:
    - export DISPLAY=:99  # Ensure display is set
    - echo "üß™ Running TDD Test Suite..."
    - cd tests/tdd
    - chmod +x generate_junit_report.sh
    - ./generate_junit_report.sh
  artifacts:
    when: always
    reports:
      junit: tests/tdd/test-results.xml
    paths:
      - tests/tdd/*.log
      - tests/tdd/test-results.xml
    expire_in: 1 week

# Unit test job - run individual test categories
test:daemon_jsonrpc:
  stage: test
  needs: ["build:tdd_tests"]
  script:
    - echo "üß™ Running Daemon JSON-RPC Tests..."
    - cd tests/tdd
    - ./test_daemon_jsonrpc_tdd
  allow_failure: false

test:daemon_integration:
  stage: test
  needs: ["build:tdd_tests"]
  before_script:
    - apt-get update -qq
    # Install all runtime libraries needed by the daemon
    - apt-get install -y -qq libasan6 libubsan1 
      libgl1-mesa-glx libgtk-3-0 libglfw3 libglew2.2
      libglib2.0-0 libcairo2 libpango-1.0-0
      libosmesa6
      xvfb  # Virtual display for headless GUI
    # Start virtual display
    - export DISPLAY=:99
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    - sleep 3  # Give xvfb time to start
  script:
    - export DISPLAY=:99  # Ensure display is set
    - echo "üß™ Running Daemon Integration Tests..."
    - echo "WARNING - 4 tests expected to fail due to connection reuse limitation"
    - cd tests/tdd
    - ./test_daemon_integration_tdd
  allow_failure: true  # Allow failure due to 4 known failing tests

test:example_voxel:
  stage: test
  needs: ["build:tdd_tests"]
  script:
    - echo "üß™ Running Example Voxel Tests..."
    - cd tests/tdd
    - ./example_voxel_tdd
  allow_failure: false

# Memory leak detection job (optional)
test:valgrind:
  stage: test
  before_script:
    - *setup_dependencies
    - apt-get install -o dir::cache::archives="$APT_CACHE_DIR" -y -qq valgrind
  script:
    - echo "üîç Running memory leak detection..."
    - cd tests/tdd
    - make clean
    - make all
    - |
      for test in example_voxel_tdd test_daemon_jsonrpc_tdd test_daemon_integration_tdd; do
        echo "=== Checking $test for memory leaks ==="
        valgrind --leak-check=full --error-exitcode=1 ./$test || true
      done
  allow_failure: true
  when: manual

# Coverage report (optional)
test:coverage:
  stage: test
  before_script:
    - *setup_dependencies
    - apt-get install -o dir::cache::archives="$APT_CACHE_DIR" -y -qq gcovr
  script:
    - echo "üìä Generating test coverage report..."
    - cd tests/tdd
    - make clean
    - make CFLAGS="-Wall -Wextra -g -std=c99 --coverage" LDFLAGS="-lm --coverage" all
    - make run_tests
    - gcovr --xml-pretty --exclude-unreachable-branches --print-summary -o coverage.xml --root ${CI_PROJECT_DIR}
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: tests/tdd/coverage.xml
    expire_in: 1 week
  allow_failure: true
  when: manual

# Quick sanity check - runs on all branches
test:quick:
  stage: test
  before_script:
    - *setup_dependencies
  script:
    - echo "‚ö° Quick TDD sanity check..."
    - cd tests/tdd
    - make clean
    - make example_voxel_tdd
    - ./example_voxel_tdd
    - echo "‚úÖ Quick test passed!"
